#!/usr/bin/env python3
import click
import uvicorn
import psutil
import schedule
import asyncio
import httpx
from pathlib import Path
from datetime import datetime
from typing import Dict

services_db = Path.home() / ".aios" / "services.json"
services_db.parent.mkdir(exist_ok=True)
services_db.touch(exist_ok=True)

@click.group()
def cli():
    pass

@cli.command()
@click.argument('service_name')
def start(service_name):
    import json
    data = json.loads(services_db.read_text() or '{}')
    data[service_name] = {'status': 'running', 'started': datetime.now().isoformat()}
    services_db.write_text(json.dumps(data))
    click.echo(f"Started {service_name}")

@cli.command()
def status():
    import json
    data = json.loads(services_db.read_text() or '{}')
    [click.echo(f"{k}: {v.get('status', 'unknown')}") for k, v in data.items()]

@cli.command()
def web():
    uvicorn.run("aios_web:app", host="0.0.0.0", port=8000)

@cli.command()
@click.argument('prompt')
def ai(prompt):
    async def run():
        async with httpx.AsyncClient() as client:
            response = await client.post('http://localhost:8000/ai', json={'prompt': prompt})
            click.echo(response.json().get('response'))
    asyncio.run(run())

cli()