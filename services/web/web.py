#!/usr/bin/env python3
import sys; sys.path.extend(['/home/seanpatten/projects/AIOS', '/home/seanpatten/projects/AIOS/core'])
from http.server import HTTPServer, BaseHTTPRequestHandler
import json, aios_db, subprocess, os, asyncio, websockets, pty, struct, fcntl, termios, signal
from urllib.parse import parse_qs, urlparse
from datetime import datetime
from pathlib import Path
from threading import Thread

TEMPLATE_DIR, WEB_PORT = Path(__file__).parent / 'templates', int(sys.argv[2]) if len(sys.argv) > 2 else 8080
T = {k: (TEMPLATE_DIR / v).read_text() for k, v in {'index': 'index.html', 'todo': 'todo.html', 'jobs': 'jobs.html', 'feed': 'feed.html', 'autollm': 'autollm.html', 'autollm_output': 'autollm_output.html', 'terminal': 'terminal.html', 'terminal_emulator': 'terminal-emulator.html', 'terminal_xterm': 'terminal-xterm.html', 'settings': 'settings.html', 'workflow': 'workflow.html', 'workflow_manager': 'workflow_manager.html'}.items()}

class Handler(BaseHTTPRequestHandler):
    def _ctx(self): s, c = aios_db.read("settings") or {}, {}; c.update({'bg': {'light': '#fff'}.get(s.get('theme'), '#000'), 'fg': {'light': '#000'}.get(s.get('theme'), '#fff'), 'bg2': {'light': '#f0f0f0'}.get(s.get('theme'), '#1a1a1a')}); return s, c

    def do_GET(self):
        p, q, s, c = urlparse(self.path), parse_qs(urlparse(self.path).query), *self._ctx()
        H = {'/': lambda: (T['index'].format(**c), 'text/html'), '/api/jobs': lambda: (json.dumps([{"id": j[0], "name": j[1], "status": j[2], "output": j[3]} for j in aios_db.query("jobs", "SELECT id, name, status, output FROM jobs ORDER BY created DESC")]), 'application/json'), '/todo': lambda: (T['todo'].format(**c, tasks="".join([f'<div class="task {"done" * ("[x]" in t)}">{t} <form style="display:inline" action="/todo/done" method="POST"><input type="hidden" name="id" value="{t.split(".")[0] or str(i+1)}"><button>Done</button></form></div>' for i, t in enumerate(subprocess.run(["python3", "core/aios_runner.py", "python3", "programs/todo/todo.py", "list"], capture_output=True, text=True).stdout.strip().split('\n') or [])]) or '<div style="color:#888">No tasks yet</div>'), 'text/html'), '/feed': lambda: (T['feed'].format(**c, feed_content=(lambda m, d=[]: "".join([d.append(datetime.fromisoformat(x[1]).date()) or (f'<div style="color:#888;font-weight:bold;margin:15px 0 5px">{datetime.fromisoformat(x[1]).date()}</div>' if datetime.fromisoformat(x[1]).date() not in d else '') + f'<div style="padding:8px;margin:2px 0">{datetime.fromisoformat(x[1]).strftime({"12h": "%I:%M %p"}.get(s.get("time_format", "12h"), "%H:%M"))} - {x[0]}</div>' for x in m]) or "<div style='color:#888'>No messages yet</div>")(aios_db.query("feed", "SELECT content, timestamp FROM messages ORDER BY timestamp DESC LIMIT 100"))), 'text/html'), '/settings': lambda: (T['settings'].format(**c, theme_dark_style={'dark': 'style="font-weight:bold"'}.get(s.get('theme', 'dark'), ''), theme_light_style={'light': 'style="font-weight:bold"'}.get(s.get('theme'), ''), time_12h_style={'12h': 'style="font-weight:bold"'}.get(s.get('time_format', '12h'), ''), time_24h_style={'24h': 'style="font-weight:bold"'}.get(s.get('time_format'), '')), 'text/html'), '/jobs': lambda: (T['jobs'].format(**c, **{k: subprocess.run(f"python3 services/jobs.py {v}", shell=True, capture_output=True, text=True, timeout=5).stdout.strip() or f'<div style="color:#888;padding:10px">No {v} jobs</div>' for k, v in {'running_jobs': 'running', 'review_jobs': 'review', 'done_jobs': 'done'}.items()}), 'text/html'), '/autollm': lambda: (T['autollm'].format(**c, **{f'{k}_worktrees': "".join([h(w) for w in g]) or f'<div style="color:#888">No {k} worktrees</div>' for k, g, h in [('running', [w for w in aios_db.query("autollm", "SELECT branch, path, job_id, status, task, model FROM worktrees") if w[3] == 'running'], lambda w: f'<div class="worktree"><span class="status running">{w[0]}</span><br>{w[5]}: {w[4][:30]}<br><pre style="background:#000;padding:5px;margin:5px 0;max-height:100px;overflow-y:auto;font-size:10px">{((Path.home() / ".aios" / f"autollm_output_{w[2]}.txt").read_text()[-200:] if (Path.home() / ".aios" / f"autollm_output_{w[2]}.txt").exists() else "Waiting for output...")}</pre><a href="/autollm/output?job_id={w[2]}" style="padding:5px 10px;background:{c["fg"]};color:{c["bg"]};text-decoration:none;border-radius:3px">Full Output</a><a href="/terminal?job_id={w[2]}" style="padding:5px 10px;background:{c["fg"]};color:{c["bg"]};text-decoration:none;border-radius:3px;margin-left:5px">Terminal</a></div>'), ('review', [w for w in aios_db.query("autollm", "SELECT branch, path, job_id, status, task, model, output FROM worktrees") if w[3] == 'review'], lambda w: f'<div class="worktree"><span class="status review">{w[0]}</span><br>{w[5]}: {w[4][:30]}<br>Output: {(w[6] or "")[:50]}<br><form action="/autollm/accept" method="POST" style="display:inline"><input type="hidden" name="job_id" value="{w[2]}"><button>Accept</button></form><form action="/autollm/vscode" method="POST" style="display:inline"><input type="hidden" name="path" value="{w[1]}"><button>VSCode</button></form></div>'), ('done', [w for w in aios_db.query("autollm", "SELECT branch, path FROM worktrees") if len(w) > 3 and w[3] == 'done'], lambda w: f'<div class="worktree"><span class="status done">{w[0]}</span></div>')]}), 'text/html'), '/autollm/output': lambda: (T['autollm_output'].format(**c, output_content=(lambda j, f: f.read_text() if f.exists() else ((lambda d: d[0][0] if d else "No output yet")(aios_db.query("autollm", "SELECT output FROM worktrees WHERE job_id=?", (j,)))))(q.get('job_id', [''])[0], Path.home() / ".aios" / f"autollm_output_{q.get('job_id', [''])[0]}.txt")), 'text/html'), '/terminal': lambda: (T['terminal'].format(**c, terminal_content=(lambda j, f: f.read_text() if f.exists() else "Waiting for output...")(q.get('job_id', [''])[0], Path.home() / ".aios" / f"autollm_output_{q.get('job_id', [''])[0]}.txt"), job_id=q.get('job_id', [''])[0]), 'text/html'), '/terminal-emulator': lambda: (T['terminal_emulator'].replace('ws://localhost:8766', f'ws://localhost:{WEB_PORT + 1000}'), 'text/html'), '/terminal-xterm': lambda: (T['terminal_xterm'].replace('ws://localhost:8766', f'ws://localhost:{WEB_PORT + 1000}'), 'text/html'), '/workflow': lambda: (T['workflow'].format(**c), 'text/html'), '/workflow-manager': lambda: (T['workflow_manager'].format(**c), 'text/html'), '/workflow/list_worktrees': lambda: (json.dumps([{"path": l.split()[0], "branch": l.split()[2].strip('[]')} for l in subprocess.run(["git", "worktree", "list"], capture_output=True, text=True, timeout=5).stdout.strip().split('\n') if l and len(l.split()) >= 3]), 'application/json'), '/api/workflow/nodes': lambda: (json.dumps(aios_db.read("workflow_nodes") or []), 'application/json')}
        ct, ty = H.get(p.path, lambda: (T['index'].format(**c), 'text/html'))(); self.send_response(200); self.send_header('Content-type', ty); self.end_headers(); self.wfile.write(ct.encode())

    def do_POST(self):
        p, b = urlparse(self.path).path, self.rfile.read(int(self.headers.get('Content-Length', 0))) or b''
        if p.startswith('/workflow/'): d = json.loads(b.decode() or '{}'); (p == '/workflow/worktree_terminal' and (lambda r: (self.send_response(200), self.send_header('Content-type', 'application/json'), self.end_headers(), self.wfile.write(json.dumps(json.loads(r.stdout) if r.stdout else {"error": "No output"}).encode())))(subprocess.run(["python3", "programs/workflow/workflow.py", "worktree_terminal", d.get('repo', '/home/seanpatten/projects/AIOS'), d.get('branch', '')], capture_output=True, text=True, timeout=10)) or p == '/workflow/remove_worktree' and (subprocess.run(["git", "worktree", "remove", d.get('path', '')], check=True, timeout=5), self.send_response(200), self.send_header('Content-type', 'application/json'), self.end_headers(), self.wfile.write(b'{"success":true}')) or (subprocess.run({'/workflow/add': f"python3 programs/workflow/workflow.py add {d.get('col', 0)} {d.get('text', '')}", '/workflow/expand': f"python3 programs/workflow/workflow.py expand {d.get('id', 0)} {d.get('text', '')}", '/workflow/branch': f"python3 programs/workflow/workflow.py branch {d.get('id', 0)}", '/workflow/exec': f"python3 programs/workflow/workflow.py exec {d.get('id', 0)}", '/workflow/push': f"python3 programs/workflow/workflow.py push {d.get('id', 0)}", '/workflow/term': f"python3 programs/workflow/workflow.py term {d.get('id', 0)}", '/workflow/comment': f"python3 programs/workflow/workflow.py comment {d.get('id', 0)} {d.get('text', '')}", '/workflow/save': f"python3 programs/workflow/workflow.py save {d.get('name', 'default')}", '/workflow/load': f"python3 programs/workflow/workflow.py load {d.get('name', 'default')}"}.get(p, ""), shell=True, timeout=5, capture_output=True), self.send_response(200), self.send_header('Content-type', 'application/json'), self.end_headers(), self.wfile.write(b'{"status":"ok"}'))); return
        if p == '/shutdown': self.send_response(200); self.send_header('Content-type', 'text/html'); self.end_headers(); self.wfile.write(b'<html><body><h1>Shutting down AIOS...</h1><script>setTimeout(function(){window.close();}, 2000);</script></body></html>'); [os.kill(pid, signal.SIGTERM) for pid in (aios_db.read("aios_pids") or {}).values() if True]; os._exit(0)
        if p == '/restart': self.send_response(200); self.send_header('Content-type', 'text/html'); self.end_headers(); self.wfile.write(b'<html><body><h1>Restarting AIOS...</h1><script>setTimeout(function(){location.href="/";}, 3000);</script></body></html>'); Thread(target=lambda: (__import__('time').sleep(0.5), subprocess.Popen(["python3", "/home/seanpatten/projects/AIOS/core/aios_start.py"]), __import__('time').sleep(1), os._exit(0))[-1], daemon=True).start(); return
        if p == '/worktree/create': d, r = parse_qs(b.decode()) or {}, subprocess.run(["python3", "/home/seanpatten/projects/AIOS/programs/worktree/worktree_manager.py", "create", d.get('repo', [''])[0], d.get('branch', [''])[0]], capture_output=True, text=True, timeout=10); self.send_response(200); self.send_header('Content-type', 'text/html'); self.end_headers(); self.wfile.write(f'<html><body><h2>Worktree Created</h2><pre>{r.stdout if r.returncode == 0 else f"Error: {r.stderr}"}</pre><br><a href="/">Back to Control Center</a></body></html>'.encode()); return
        d = parse_qs(b.decode()) or {}; subprocess.run({'/job/run': "python3 services/jobs.py run_wiki", '/job/accept': f"python3 services/jobs.py accept {d.get('id', [''])[0]}", '/job/redo': f"python3 services/jobs.py redo {d.get('id', [''])[0]}", '/run': d.get('cmd', [''])[0], '/todo/add': f"python3 programs/todo/todo.py add {d.get('task', [''])[0]}", '/todo/done': f"python3 programs/todo/todo.py done {d.get('id', [''])[0]}", '/todo/clear': "python3 programs/todo/todo.py clear", '/settings/theme': f"python3 programs/settings/settings.py set theme {d.get('theme', ['dark'])[0]}", '/settings/time': f"python3 programs/settings/settings.py set time_format {d.get('format', ['12h'])[0]}", '/autollm/run': f"python3 programs/autollm/autollm.py run {d.get('repo', [''])[0]} {d.get('branches', ['1'])[0]} {d.get('model', ['claude-3-5-sonnet-20241022'])[0]} {d.get('task', [''])[0]}", '/autollm/accept': f"python3 programs/autollm/autollm.py accept {d.get('job_id', [''])[0]}", '/autollm/vscode': f"code {d.get('path', [''])[0]}", '/autollm/clean': "python3 programs/autollm/autollm.py clean"}.get(p, ""), shell=True, timeout=5, capture_output=True); self.send_response(303); self.send_header('Location', '/autollm' if 'autollm' in p else '/settings' if 'settings' in p else p.replace('/add', '').replace('/done', '').replace('/clear', '')); self.end_headers()

    def log_message(self, *args): pass

async def client_handler(ws):
    m, s = pty.openpty(); fcntl.ioctl(s, termios.TIOCSWINSZ, struct.pack('HHHH', 24, 80, 0, 0)); proc = await asyncio.create_subprocess_exec('bash', stdin=s, stdout=s, stderr=s, preexec_fn=os.setsid); os.close(s); os.set_blocking(m, False); loop = asyncio.get_event_loop(); loop.add_reader(m, lambda: (lambda d: d and asyncio.create_task(ws.send(d)))(os.read(m, 65536) if True else None))
    try:
        async for msg in ws:
            isinstance(msg, bytes) and (msg[0:1] == b'{' and (lambda d: 'resize' in d and fcntl.ioctl(m, termios.TIOCSWINSZ, struct.pack('HHHH', d['resize']['rows'], d['resize']['cols'], 0, 0)))(json.loads(msg.decode())) or os.write(m, msg))
    finally: loop.remove_reader(m); proc.terminate(); await proc.wait(); os.close(m)

def serve_http(sock=None): s = HTTPServer(('', WEB_PORT), Handler, bind_and_activate=(sock is None)); s.socket = sock if sock else s.socket; s.serve_forever()

async def main():
    import socket; sock = socket.fromfd(int(sys.argv[1]), socket.AF_INET, socket.SOCK_STREAM) if len(sys.argv) > 1 else None; Thread(target=serve_http, args=(sock,), daemon=True).start(); ws_port = WEB_PORT + 1000
    try:
        async with websockets.serve(client_handler, 'localhost', ws_port): await asyncio.Future()
    except OSError:
        async with websockets.serve(client_handler, 'localhost', WEB_PORT + 2000): await asyncio.Future()

asyncio.run(main())
