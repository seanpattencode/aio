<!DOCTYPE html>
<html><head><title>Terminal Emulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{{margin:0;padding:0;box-sizing:border-box}}
body{{background:#000;font:14px monospace;color:#dfdbd2;padding:20px;margin:0;overflow:hidden;height:100vh;box-sizing:border-box}}
#add-terminal{{padding:10px 20px;background:#333;border:1px solid #555;color:#dfdbd2;cursor:pointer;margin-bottom:10px;border-radius:5px;display:block;width:fit-content}}
#terminals-container{{height:calc(100vh - 70px);overflow-y:auto}}
.terminal-box{{background:#111;border:1px solid #333;border-radius:10px;padding:5px;margin-bottom:10px;overflow:hidden;display:flex;flex-direction:column}}
#term{{flex:1;overflow-x:auto;overflow-y:auto;min-height:0}}
.cmd-bar{{padding:5px;border-top:1px solid #333;flex-shrink:0;background:#111}}
.line{{white-space:pre-wrap;word-wrap:break-word;user-select:text}}
#prompt-line{{white-space:pre;padding-left:12px;position:relative}}
#prompt-line:before{{content:'$ ';position:absolute;left:0;top:0}}
#input{{background:transparent;border:none;color:#dfdbd2;font:14px monospace;outline:none;width:100%;padding:0}}
</style></head><body>
<button id="add-terminal" onclick="addTerminal()">+ Add Terminal</button>
<div id="terminals-container">
<div class="terminal-box">
  <div id="term">
    <div id="prompt-line"><input id="input" type="text" autocomplete="off" spellcheck="false"/></div>
  </div>
  <div class="cmd-bar">
    <select id="term-preset" style="padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-right:5px">
      <option value="">Quick Commands</option>
      <option value="claude --dangerously-skip-permissions">Claude</option>
      <option value='codex -c model_reasoning_effort="high" --model gpt-5-codex --dangerously-bypass-approvals-and-sandbox'>Codex</option>
    </select>
    <button onclick="usePreset('term')" style="padding:5px 10px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer">Use</button>
    <input id="term-cmd" type="text" style="width:calc(100% - 420px);padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-left:5px" placeholder="Enter command..." onkeydown="if(event.key==='Enter')sendTermCmd()"/>
    <button onclick="sendTermCmd()" style="padding:5px 15px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer;margin-left:5px">Send</button>
  </div>
</div>
<div class="terminal-box">
  <div style="flex:1;min-height:0;overflow:hidden">
    <div id="xterm" style="width:100%;height:100%"></div>
  </div>
  <div class="cmd-bar">
    <select id="xterm-preset" style="padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-right:5px">
      <option value="">Quick Commands</option>
      <option value="claude --dangerously-skip-permissions">Claude</option>
      <option value='codex -c model_reasoning_effort="high" --model gpt-5-codex --dangerously-bypass-approvals-and-sandbox'>Codex</option>
    </select>
    <button onclick="usePreset('xterm')" style="padding:5px 10px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer">Use</button>
    <input id="xterm-cmd" type="text" style="width:calc(100% - 420px);padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-left:5px" placeholder="Enter command..." onkeydown="if(event.key==='Enter')sendXtermCmd()"/>
    <button onclick="sendXtermCmd()" style="padding:5px 15px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer;margin-left:5px">Send</button>
  </div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css"/>
<script>
const term = document.getElementById('term');
const promptLine = document.getElementById('prompt-line');
const input = document.getElementById('input');
const ws = new WebSocket('ws://localhost:8766');
ws.binaryType = 'arraybuffer';
let history = [];
let historyIndex = -1;
let ignoreNext = false;
let currentCols = 80;
let currentRows = 24;

const ansiRegex = /\x1b\[[^\x1b]*?[a-zA-Z]/g;
const controlRegex = /[\x00-\x1F\x7F]/g;

const byteToChar = new Array(256);
for(let i=0;i<256;i++)byteToChar[i]=String.fromCharCode(i);

function calculateSize() {{
  const cols = Math.floor((window.innerWidth - 20) / 8.4);
  const rows = Math.floor((window.innerHeight - 20) / 16.8);
  currentCols = cols;
  currentRows = rows;
}}

ws.onopen = () => {{
  calculateSize();
  const msg = JSON.stringify({{resize:{{rows:currentRows,cols:currentCols}},term:'xterm-256color'}});
  const bytes = new Uint8Array(msg.length);
  for(let i=0;i<msg.length;i++)bytes[i]=msg.charCodeAt(i);
  ws.send(bytes);
}};

ws.onmessage = e => {{
  const bytes = new Uint8Array(e.data);
  let str = '';
  for(let i=0;i<bytes.length;i++)str+=byteToChar[bytes[i]];

  if(ignoreNext && str.includes(input.value)){{ignoreNext=false;return;}}

  const clean = str.replace(ansiRegex,'').replace(controlRegex,c=>c==='\n'?'\n':'');

  let start = 0;
  for(let i=0;i<clean.length;i++){{
    if(clean[i]==='\n'){{
      const line = document.createElement('div');
      line.className = 'line';
      line.textContent = clean.substring(start,i);
      term.insertBefore(line,promptLine);
      start = i+1;
    }}
  }}
  if(start<clean.length){{
    const line = document.createElement('div');
    line.className = 'line';
    line.textContent = clean.substring(start);
    term.insertBefore(line,promptLine);
  }}

  promptLine.scrollIntoView();
}};

input.onkeydown = e => {{
  const k = e.key;
  let data = null;

  // Only handle if input is focused
  if(document.activeElement !== input) return;

  if(e.ctrlKey){{
    const key = k.toLowerCase();
    if(key==='c'){{data='\x03';input.value='';e.preventDefault();}}
    else if(key==='d'){{data='\x04';e.preventDefault();}}
    else if(key==='l'){{term.innerHTML='';term.appendChild(promptLine);data='\x0c';e.preventDefault();}}
  }}else{{
    if(k==='Enter'){{
      const cmd = input.value;
      if(cmd){{history.push(cmd);historyIndex=history.length;}}

      calculateSize();
      const resizeMsg = JSON.stringify({{resize:{{rows:currentRows,cols:currentCols}}}});
      const resizeBytes = new Uint8Array(resizeMsg.length);
      for(let i=0;i<resizeMsg.length;i++)resizeBytes[i]=resizeMsg.charCodeAt(i);
      ws.send(resizeBytes);

      data = cmd+'\r';
      ignoreNext=true;
      input.value='';
      e.preventDefault();
    }}else if(k==='ArrowUp'){{
      if(historyIndex>0){{historyIndex--;input.value=history[historyIndex];}}
      e.preventDefault();
    }}else if(k==='ArrowDown'){{
      if(historyIndex<history.length-1){{historyIndex++;input.value=history[historyIndex];}}
      else{{historyIndex=history.length;input.value='';}}
      e.preventDefault();
    }}else if(k==='Tab'){{data='\t';e.preventDefault();}}
  }}

  if(data){{
    const bytes = new Uint8Array(data.length);
    for(let i=0;i<data.length;i++)bytes[i]=data.charCodeAt(i);
    ws.send(bytes);
  }}
}};

term.onclick = e => {{
  if(e.target !== input) input.blur();
}};

// Terminal management
let terminalCount = 2;
const terminals = [];

function updateTerminalSizes() {{
  const container = document.getElementById('terminals-container');
  const boxes = document.querySelectorAll('.terminal-box');
  const count = boxes.length;

  const minHeight = 200;
  const buttonHeight = 50;
  const containerPadding = 40;
  const boxMargin = 10;
  const totalMargins = (count - 1) * boxMargin;
  const availableHeight = window.innerHeight - buttonHeight - containerPadding;
  const calculatedHeight = Math.max(minHeight, Math.floor((availableHeight - totalMargins) / count));

  let i = 0;
  while(i < boxes.length) {{
    boxes[i].style.height = calculatedHeight + 'px';
    i++;
  }}
}}

function addTerminal() {{
  terminalCount++;
  const container = document.getElementById('terminals-container');
  const termId = 'xterm-' + terminalCount;
  const cmdId = 'cmd-' + terminalCount;
  const presetId = 'preset-' + terminalCount;

  const termBox = document.createElement('div');
  termBox.className = 'terminal-box';
  termBox.innerHTML = `
    <div style="flex:1;min-height:0;overflow:hidden">
      <div id="${{termId}}" style="width:100%;height:100%"></div>
    </div>
    <div class="cmd-bar">
      <select id="${{presetId}}" style="padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-right:5px">
        <option value="">Quick Commands</option>
        <option value="claude --dangerously-skip-permissions">Claude</option>
        <option value='codex -c model_reasoning_effort="high" --model gpt-5-codex --dangerously-bypass-approvals-and-sandbox'>Codex</option>
      </select>
      <button onclick="usePresetDynamic('${{termId}}', '${{presetId}}', '${{cmdId}}')" style="padding:5px 10px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer">Use</button>
      <input id="${{cmdId}}" type="text" style="width:calc(100% - 420px);padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-left:5px" placeholder="Enter command..." onkeydown="if(event.key==='Enter')sendDynamicCmd('${{termId}}', '${{cmdId}}')"/>
      <button onclick="sendDynamicCmd('${{termId}}', '${{cmdId}}')" style="padding:5px 15px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer;margin-left:5px">Send</button>
    </div>
  `;

  container.appendChild(termBox);

  setTimeout(() => {{
    const xterm = new Terminal();
    const xtermFit = new FitAddon.FitAddon();
    xterm.loadAddon(xtermFit);
    xterm.open(document.getElementById(termId));
    xtermFit.fit();
    const xtermWs = new WebSocket('ws://localhost:8766');
    xtermWs.binaryType = 'arraybuffer';
    xtermWs.onmessage = e => xterm.write(new Uint8Array(e.data));
    xterm.onData(d => xtermWs.send(new TextEncoder().encode(d)));

    terminals.push({{ id: termId, term: xterm, fit: xtermFit, ws: xtermWs }});

    updateTerminalSizes();
    xtermFit.fit();
  }}, 100);
}}

function usePresetDynamic(termId, presetId, cmdId) {{
  const select = document.getElementById(presetId);
  const cmd = select.value;
  if(cmd) {{
    document.getElementById(cmdId).value = cmd;
    select.selectedIndex = 0;
  }}
}}

function sendDynamicCmd(termId, cmdId) {{
  const cmd = document.getElementById(cmdId).value;
  if(cmd) {{
    const terminal = terminals.find(t => t.id === termId);
    if(terminal) {{
      terminal.ws.send(new TextEncoder().encode(cmd + '\r'));
      document.getElementById(cmdId).value = '';
    }}
  }}
}}

// Command send functions
function usePreset(termType) {{
  const select = document.getElementById(termType + '-preset');
  const cmd = select.value;
  if(cmd) {{
    document.getElementById(termType + '-cmd').value = cmd;
    select.selectedIndex = 0;
  }}
}}

function sendTermCmd() {{
  const cmd = document.getElementById('term-cmd').value;
  if(cmd) {{
    const data = cmd + '\r';
    const bytes = new Uint8Array(data.length);
    for(let i=0;i<data.length;i++)bytes[i]=data.charCodeAt(i);
    ws.send(bytes);
    document.getElementById('term-cmd').value = '';
  }}
}}

function sendXtermCmd() {{
  const cmd = document.getElementById('xterm-cmd').value;
  if(cmd) {{
    xtermWs.send(new TextEncoder().encode(cmd + '\r'));
    document.getElementById('xterm-cmd').value = '';
  }}
}}

// XTerm setup
let xtermWs;
let mainXterm;
let mainXtermFit;
setTimeout(() => {{
  mainXterm = new Terminal();
  mainXtermFit = new FitAddon.FitAddon();
  mainXterm.loadAddon(mainXtermFit);
  mainXterm.open(document.getElementById('xterm'));
  mainXtermFit.fit();
  xtermWs = new WebSocket('ws://localhost:8766');
  xtermWs.binaryType = 'arraybuffer';
  xtermWs.onmessage = e => mainXterm.write(new Uint8Array(e.data));
  mainXterm.onData(d => xtermWs.send(new TextEncoder().encode(d)));

  window.onresize = () => {{
    updateTerminalSizes();
    mainXtermFit.fit();
    let i = 0;
    while(i < terminals.length) {{
      terminals[i].fit.fit();
      i++;
    }}
  }};
}}, 100);
</script>
</body></html>
