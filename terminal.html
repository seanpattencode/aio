<!DOCTYPE html>
<html><head><title>AIOS Terminal - {job_name}</title>
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css"/>
<style>
body {
    margin: 0;
    padding: 0;
    background: #000;
    overflow: hidden;
}
#terminal {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}
</style>
</head><body>
<div id="terminal"></div>
<script>
const term = new Terminal({
    cursorBlink: true,
    fontSize: 14,
    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
    theme: {
        background: '#000000',
        foreground: '#ffffff'
    },
    scrollback: 10000,
    convertEol: true
});
const fitAddon = new FitAddon.FitAddon();
term.loadAddon(fitAddon);
term.open(document.getElementById('terminal'));
fitAddon.fit();

const params = new URLSearchParams(window.location.search);
const session = params.get('session');
const ws = new WebSocket('ws://localhost:7682/attach/' + session);
ws.binaryType = 'arraybuffer';

ws.onopen = () => {
    fitAddon.fit();
    const { cols, rows } = term;
    ws.send(JSON.stringify({ resize: { cols, rows } }));
};

ws.onmessage = e => {
    term.write(new Uint8Array(e.data));
};

term.onData(data => {
    ws.send(new TextEncoder().encode(data));
});

window.addEventListener('resize', () => {
    fitAddon.fit();
    const { cols, rows } = term;
    ws.send(JSON.stringify({ resize: { cols, rows } }));
});

// Initial resize after a short delay to ensure proper sizing
setTimeout(() => {
    fitAddon.fit();
    const { cols, rows } = term;
    ws.send(JSON.stringify({ resize: { cols, rows } }));
}, 100);
</script>
</body></html>