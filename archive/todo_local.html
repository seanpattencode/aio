<!DOCTYPE html>
<html>
<head><script>var B='http://localhost:43153';(function(){const F=window.fetch;window.fetch=(p,o)=>F(p.startsWith('/')?B+p:p,o);})();</script>
  <title>Todo App</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:20px;background:#f5f5f5}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:#fff;padding:12px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.1);margin:10px 0}
    .essential{border-left:4px solid #ff6b6b}
    .small{color:#666;font-size:13px}
    button{padding:6px 10px;border:0;border-radius:4px;cursor:pointer}
    .green{background:#4caf50;color:#fff}.orange{background:#ff9800;color:#fff}.blue{background:#03a9f4;color:#fff}
    .filter{background:#2196f3;color:#fff}.active{background:#0d47a1}
    #logs{background:#333;color:#fff;padding:12px;border-radius:6px;max-height:200px;overflow:auto;font:12px/1.4 monospace}
    .hidden{display:none}
    .dropdown{position:relative;display:inline-block}
    .menu{display:none;position:absolute;background:#f9f9f9;min-width:140px;box-shadow:0 8px 16px rgba(0,0,0,.2);border-radius:6px;z-index:2}
    .menu button{width:100%;background:none;color:#000;text-align:left;padding:10px}
    .menu button:hover{background:#f1f1f1}
    .time-editor{position:absolute;background:#fff;border:1px solid #ddd;padding:8px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .close-x{position:absolute;top:5px;right:10px;font-size:20px;cursor:pointer;color:#999}
    .close-x:hover{color:#333}
  </style>
</head>
<body>
  <div class="row" style="justify-content:space-between;margin-bottom:10px">
    <h1>Todo App</h1>
    <div id="stats" class="card small hidden">Startup: <span id="startup"></span>ms | FPS: <span id="fps"></span> | Tasks: <span id="count"></span></div>
  </div>
  <div class="row">
    <button class="filter active" onclick="setFilter('next',this)">Next 4</button>
    <button class="filter" onclick="setFilter('future',this)">Future</button>
    <div class="dropdown">
      <button class="filter" onclick="toggleMenu(event)">More</button>
      <div class="menu" id="menu">
        <button onclick="setFilter('essential',this)">Essential</button>
        <button onclick="setFilter('all',this)">All</button>
        <button onclick="toggleLogs()">Toggle Logs</button>
        <button onclick="toggleStats()">Toggle Stats</button>
        <button onclick="simulateConflict()">Simulate Conflict</button>
      </div>
    </div>
  </div>
  <div class="card row">
    <input id="desc" type="text" placeholder="Task description" style="flex:1;padding:6px;border:1px solid #ddd;border-radius:4px">
    <input id="time" type="time" style="padding:6px;border:1px solid #ddd;border-radius:4px">
    <button class="green" onclick="addTask()">Add Task</button>
  </div>
  <div id="tasks"></div>
  <div id="logs" class="hidden"></div>
<script>
const WS_URL = "ws://localhost:44459";
const q = s => document.querySelector(s);
const qa = s => [...document.querySelectorAll(s)];
const get = p => fetch(p).then(r=>r.json());
const post = (p,o) => fetch(p,{method:'POST',body:new URLSearchParams(o)});
let ws, filter='next', tasks=[], statsOn=false, logsOn=false, editor=null;
function connect(){
  if(ws) return;
  ws = new WebSocket(WS_URL);
  ws.onopen = ()=>console.log('WS connected');
  ws.onmessage = e => { 
    const d = JSON.parse(e.data); 
    if(d.type==='update'){ load(); if(logsOn) loadLogs(); updateStats(); } 
    else if(d.type==='conflict'){ showConflictBubble(d); }
  };
  ws.onclose = ()=>{ ws=null; setTimeout(connect,1000); };
  ws.onerror = ()=>ws.close();
}
function toggleMenu(e){ e.stopPropagation(); const m=e.target.nextElementSibling; if(m) m.style.display = m.style.display==='block'?'none':'block'; }
window.onclick = e => { if(!e.target.matches('.dropdown button')) q('#menu').style.display='none'; };
function setFilter(f,btn){
  filter=f; qa('.filter').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); load();
}
function toggleStats(){ statsOn=!statsOn; q('#stats').classList.toggle('hidden',!statsOn); }
function toggleLogs(){ logsOn=!logsOn; q('#logs').classList.toggle('hidden',!logsOn); if(logsOn) loadLogs(); }
async function load(){ tasks = await get(`/api/tasks?filter=${filter}`); render(); }
function render(){
  const c = q('#tasks'); c.innerHTML='';
  tasks.forEach(t=>{
    const el = document.createElement('div'); el.className = `card ${t.essential?'essential':''}`;
    el.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <span style="font-weight:bold">${t.description}</span>
        <span class="small">${t.recurrence_time}</span>
      </div>
      <div class="small">Streak: ${t.streak} | Next: ${new Date(t.next_occurrence).toLocaleString()}</div>
      <div class="row" style="margin-top:8px">
        <button class="green" onclick="complete(${t.id},true)">Complete</button>
        <button class="orange" onclick="complete(${t.id},false)">Not Complete</button>
        <button class="blue" onclick="openTime(${t.id},event)">Edit Time</button>
        <div class="dropdown">
          <button onclick="toggleMenu(event)">More</button>
          <div class="menu">
            <button onclick="editName(${t.id})">Edit Name</button>
            <button onclick="toggleEssential(${t.id})">${t.essential?'Unmark Essential':'Mark Essential'}</button>
            <button onclick="showStats(${t.id})">Stats</button>
            <button onclick="archive(${t.id})">Archive</button>
          </div>
        </div>
      </div>`;
    c.appendChild(el);
  });
}
async function addTask(){
  const d=q('#desc').value.trim(), tm=q('#time').value; if(!d) return;
  await post('/api/add_task',{description:d,recurrence_time:tm}); q('#desc').value=''; q('#time').value=''; load();
}
async function complete(id, done){ await post('/api/complete_task',{task_id:id,completed:done}); load(); }
async function toggleEssential(id){
  const t = tasks.find(x=>x.id===id); await post('/api/edit_task',{task_id:id,essential:!t.essential}); load();
}
async function editName(id){
  const t = tasks.find(x=>x.id===id); const nd = prompt('Edit task description:', t.description);
  if(nd===null || nd.trim()==='' || nd===t.description) return;
  await post('/api/edit_task',{task_id:id,description:nd}); load();
}
function openTime(id,ev){
  if(editor) closeEditor();
  const t = tasks.find(x=>x.id===id); if(!t) return;
  const ed = document.createElement('div'); ed.className='time-editor';
  ed.innerHTML = `<input type="time" id="edit-time" value="${t.recurrence_time}"> <button onclick="saveTime(${id})">Save</button> <button onclick="closeEditor()">Cancel</button>`;
  ed.style.left = ev.pageX+'px'; ed.style.top = ev.pageY+'px'; document.body.appendChild(ed); editor=ed; q('#edit-time').focus();
  setTimeout(()=>document.addEventListener('click', outside),0);
  function outside(e){ if(!ed.contains(e.target)) closeEditor(); } ed.outside = outside;
}
async function saveTime(id){
  const v=q('#edit-time').value; const t=tasks.find(x=>x.id===id);
  if(v===t.recurrence_time){ closeEditor(); return; }
  await post('/api/edit_task',{task_id:id,recurrence_time:v}); closeEditor(); load();
}
function closeEditor(){ if(editor){ document.removeEventListener('click', editor.outside); editor.remove(); editor=null; } }
async function archive(id){ if(!confirm('Archive this task?')) return; await post('/api/archive_task',{task_id:id}); load(); }
async function showStats(id){
  const s = await get(`/api/task/${id}`); const times = s.completion_dates.map(d=>new Date(d).toLocaleString()).join('\n');
  alert(`Completion Times:\n${times}\n\nStreak: ${s.streak}`);
}
async function loadLogs(){ q('#logs').textContent = (await get('/api/logs')).join('\n'); }
async function updateStats(){
  const s = await get('/api/stats'); q('#startup').textContent=(s.startup_time*1000).toFixed(2);
  q('#fps').textContent=s.fps.toFixed(1); q('#count').textContent=s.task_count;
}
async function simulateConflict(){
  if(tasks.length === 0) return alert('No tasks to simulate conflict on.');
  const tid = tasks[0].id;
  await post('/api/simulate_conflict',{task_id:tid});
}
function showConflictBubble(data){
  const bubble = document.createElement('div');
  bubble.style.position = 'fixed';
  bubble.style.top = '50%';
  bubble.style.left = '50%';
  bubble.style.transform = 'translate(-50%, -50%)';
  bubble.style.background = '#fff';
  bubble.style.padding = '20px';
  bubble.style.borderRadius = '8px';
  bubble.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
  bubble.style.zIndex = '1000';
  const v1Ess = data.version1.essential ? 'Yes' : 'No';
  const v2Ess = data.version2.essential ? 'Yes' : 'No';
  const diffHtml = `
    <h3>Sync Conflict for Task ${data.task_id}</h3>
    <p><strong>Version 1 (Current):</strong></p>
    <p>Description: ${data.version1.description}</p>
    <p>Essential: ${v1Ess}</p>
    <p><strong>Version 2 (Other):</strong></p>
    <p>Description: ${data.version2.description}</p>
    <p>Essential: ${v2Ess}</p>
    <div class="row" style="justify-content: center; margin-top: 10px;">
      <button class="green" onclick="resolve(${data.task_id}, '1', this)">Choose Version 1</button>
      <button class="orange" onclick="resolve(${data.task_id}, '2', this)">Choose Version 2</button>
    </div>
  `;
  bubble.innerHTML = diffHtml;
  document.body.appendChild(bubble);
  window.currentBubble = bubble;
}
async function resolve(tid, chosen, btn){
  const bubble = btn.closest('div').parentElement;
  await post('/api/resolve_conflict',{task_id:tid, chosen:chosen});
  bubble.innerHTML = `
    <span class="close-x" onclick="this.parentElement.remove()">×</span>
    <h3 style="color:#4caf50;">✓ Conflict Resolved</h3>
    <p>Successfully resolved conflict for task ${tid} with version ${chosen}</p>
  `;
  window.currentBubble = null;
}
load(); updateStats(); connect(); setInterval(updateStats,1000);
</script>
</body>
</html>